<!DOCTYPE html>
<html>
<head>
<title>Register</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light d-flex justify-content-center align-items-center vh-100">

<!-- Registration Form -->
<div id="registerCard" class="card p-4 shadow" style="width:400px;">
    <h3 class="mb-1">Create Account</h3>
    <p class="text-muted small mb-3">A verification link will be sent to your email.</p>

    <input id="username" class="form-control mb-2" placeholder="Username" autocomplete="username">
    <input id="email"    class="form-control mb-2" placeholder="Email"    type="email" autocomplete="email">
    <input id="password" class="form-control mb-3" placeholder="Password" type="password" autocomplete="new-password">

    <div id="registerError" class="alert alert-danger py-2 small d-none"></div>

    <button id="registerBtn" onclick="register()" class="btn btn-success w-100">
        Register
    </button>
    <a href="login.html" class="mt-3 d-block text-center small">Already have an account? Login</a>
</div>

<!-- Email Sent State (hidden until registration succeeds) -->
<div id="successCard" class="card p-4 shadow text-center d-none" style="width:420px;">
    <div style="font-size:3rem">ðŸ“§</div>
    <h4 class="mt-2">Check your email!</h4>
    <p class="text-muted" id="successMsg">
        We've sent a verification link to <strong id="sentTo"></strong>.
        Click the link in the email to activate your account.
    </p>
    <hr>
    <p class="text-muted small">Didn't receive it?</p>
    <button onclick="resendVerification()" id="resendBtn" class="btn btn-outline-secondary btn-sm">
        Resend verification email
    </button>
    <div id="resendMsg" class="mt-2 small text-success d-none"></div>
    <a href="login.html" class="mt-3 d-block small">Go to Login</a>
</div>

<script>
const API = "http://127.0.0.1:8000"
let registeredEmail = ""

async function register() {
    const btn = document.getElementById("registerBtn")
    const errEl = document.getElementById("registerError")

    const username = document.getElementById("username").value.trim()
    const email    = document.getElementById("email").value.trim()
    const password = document.getElementById("password").value

    if (!username || !email || !password) {
        showError("Please fill in all fields.")
        return
    }

    btn.disabled = true
    btn.textContent = "Creating accountâ€¦"
    errEl.classList.add("d-none")

    try {
        const res = await fetch(`${API}/register`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, email, password })
        })
        const data = await res.json()

        if (res.ok) {
            registeredEmail = email
            document.getElementById("sentTo").textContent = email
            document.getElementById("registerCard").classList.add("d-none")
            document.getElementById("successCard").classList.remove("d-none")

            // Development helper: show direct verify link if token is returned
            if (data.dev_verify_token) {
                const link = `${API}/verify-email?token=${data.dev_verify_token}`
                document.getElementById("successMsg").innerHTML +=
                    `<br><br><small class="text-muted">
                        <strong>Dev mode:</strong> 
                        <a href="${link}" target="_blank">Click here to verify instantly</a>
                    </small>`
            }
        } else {
            showError(data.detail || "Registration failed. Please try again.")
        }
    } catch (err) {
        showError("Could not connect to the server. Please try again.")
    } finally {
        btn.disabled = false
        btn.textContent = "Register"
    }
}

async function resendVerification() {
    const btn    = document.getElementById("resendBtn")
    const msgEl  = document.getElementById("resendMsg")

    btn.disabled = true
    btn.textContent = "Sendingâ€¦"
    msgEl.classList.add("d-none")

    try {
        const res = await fetch(`${API}/resend-verification`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email: registeredEmail })
        })
        const data = await res.json()
        msgEl.textContent = data.message || "Email sent!"
        msgEl.classList.remove("d-none")
    } catch (err) {
        msgEl.textContent = "Failed to resend. Please try again."
        msgEl.classList.remove("d-none")
        msgEl.classList.replace("text-success", "text-danger")
    } finally {
        btn.disabled = false
        btn.textContent = "Resend verification email"
        setTimeout(() => msgEl.classList.add("d-none"), 5000)
    }
}

function showError(msg) {
    const el = document.getElementById("registerError")
    el.textContent = msg
    el.classList.remove("d-none")
}
</script>

</body>
</html>